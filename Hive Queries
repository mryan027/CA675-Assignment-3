use wiki;
drop table if exists wiki_data;

-- Create a table for the raw wiki data
create external table wiki_data (id STRING, content STRING)
row format serde 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
stored as textfile
location 'hdfs:/user/maria_dev/wiki';

-- Create a table to include a list of article titles
drop table if exists page_names;
create external table page_names (id STRING, title STRING, start_num STRING, end_num STRING)
row format delimited fields terminated by ',' lines terminated by '\n' stored as textfile
location 'hdfs:/user/maria_dev/page';

-- Join title information with respective articles
drop table if exists wiki_with_headers;
create table wiki_with_headers 

as select * from
(
select a.id, a.content, b.title
from wiki_data a
left outer join page_names b
on (substr(a.id,11) = b.id)
) temp1;

--Split contents into its respective words

DROP TABLE IF EXISTS wiki_split;
CREATE TABLE wiki_split AS
SELECT title, word, count(*) as word_count

--join national names and wiki_split table
DROP TABLE IF EXISTS wiki_split_name;
CREATE TABLE wiki_split_name AS
SELECT c.title, c.word, c.word_count, o.name
FROM wiki_split c JOIN national_names o 
ON (c.word = o.name);
FROM wiki_with_headers
LATERAL VIEW explode (split(lower(content), '\\W+')) t1 AS word
GROUP BY title, word;

--Count number of words in each title
drop table if exists wiki_word_count;
create table wiki_word_count as 
SELECT title,
SUM(word_count) AS total_words
FROM wiki_split
GROUP BY title;

--upload national names database
create external table national_names (id STRING, name STRING, year STRING, gender STRING, count int)
row format serde 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
stored as textfile
location 'hdfs:/user/maria_dev/nationalnames';

--alter national_names table so that names are lower case and unique to enable joining with wiki_split
DROP TABLE IF EXISTS unique_names_lower;
CREATE TABLE unique_names_lower AS
Select lower(distinct name) as name_lower from national_names;

--join wiki_split table and unique_name_lower table
DROP TABLE IF EXISTS wiki_split_name;
CREATE TABLE wiki_split_name AS
SELECT c.title, c.word, c.word_count, o.name_lower
FROM wiki_split c JOIN unique_names_lower o 
ON (c.word = o.name_lower);

--join wiki_split_name and wiki_word_cout
DROP TABLE IF EXISTS wiki_joined;
CREATE TABLE wiki_joined AS
SELECT c.title, c.word, c.word_count, c.name_lower, o.total_words
FROM wiki_word_split c JOIN wiki_word_count o 
ON (c.title = o.title);
